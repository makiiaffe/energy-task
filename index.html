<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEURAL-OS | SMART Architect v12.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --bg: #191919; --panel: #222222; --accent: #00f2ff; 
            --burn: #ff2a6d; --gain: #05ffa1; --text: #FFFFFF; 
            --border: #2f2f2f; --level: #f5ed4e;
        }
        body.lvl-3 { --accent: #ffcc00; }
        body.lvl-5 { --accent: #00ff88; }
        body.lvl-10 { --accent: #eb5757; }

        * { box-sizing: border-box; transition: 0.1s ease; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .sidebar { width: 280px; background: var(--bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; gap: 10px; }
        .main-deck { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .void-panel { width: 280px; background: var(--bg); border-left: 1px solid var(--border); display: flex; flex-direction: column; }

        .stat-card { background: var(--panel); border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: #FFFFFF; }
        .xp-bar { width: 100%; height: 6px; background: #000; border-radius: 10px; margin-top: 8px; overflow: hidden; }
        #xp-fill { height: 100%; width: 0%; background: var(--level); box-shadow: 0 0 8px var(--level); }

        .task-card { background: var(--panel); border: 1px solid var(--border); padding: 12px; border-radius: 8px; display: flex; flex-direction: column; gap: 8px; color: #FFFFFF; position: relative; }
        .task-card.completed { border-color: var(--gain); opacity: 0.5; }
        
        .smart-zone { background: #111; padding: 12px; border-radius: 8px; border: 1px dashed var(--border); }
        .smart-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 8px; }
        .smart-input { background: #191919; border: 1px solid #333; color: #FFFFFF; padding: 6px; border-radius: 4px; font-size: 10px; text-align: center; outline: none; }
        .smart-input:focus { border-color: var(--accent); }

        .node-stepper { display: flex; align-items: center; background: #000; border-radius: 6px; border: 1px solid var(--border); padding: 2px; }
        .node-btn { background: #333; border: none; color: var(--accent); width: 22px; height: 22px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .node-input { background: none; border: none; color: #FFFFFF; width: 30px; text-align: center; font-size: 11px; font-family: monospace; }

        .btn-sync { background: var(--gain); color: #000; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; border: none; margin-top: 5px; }
        .btn-opt { background: var(--accent); color: #000; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; border: none; margin-top: 5px; }
        
        #help-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid var(--accent); max-width: 400px; font-size: 12px; color: #FFFFFF; }

        #chat-log { flex-grow: 1; padding: 10px; overflow-y: auto; font-size: 11px; display: flex; flex-direction: column; gap: 6px; }
        .msg { background: #222; padding: 8px; border-radius: 6px; border-left: 2px solid var(--accent); color: #FFFFFF; }
        .msg.opt { border-left-color: var(--gain); background: #1a2a1a; }
        
        h1, h2, h3, h4, span, div, p, label { color: #FFFFFF !important; }
        .trash-btn { color: var(--burn) !important; }
        
        select.smart-input { width: 100%; margin-top: 5px; appearance: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="help-modal">
    <div class="modal-content">
        <h3>Architect Strategy</h3>
        <p><b>Optimization Engine:</b> The system uses a topological sort to ensure dependencies are met while balancing Mental Energy (ME) to avoid burnout.</p>
        <button class="btn-sync" onclick="toggleHelp()">UNDERSTOOD</button>
    </div>
</div>

<div class="sidebar">
    <div class="stat-card">
        <h3 id="lvl-display" style="margin: 0;">LVL 1</h3>
        <div class="xp-bar"><div id="xp-fill"></div></div>
        <div style="font-size: 10px; margin-top: 8px; display:flex; justify-content:space-between">
            <span>Streak: <b id="streak-val">0</b></span>
            <span>XP: <b id="xp-val">0</b></span>
        </div>
    </div>
    <div class="stat-card">
        <div style="font-size: 9px; opacity: 0.8;">INITIAL CAPACITY (ME)</div>
        <div class="node-stepper" style="margin-top:5px; justify-content: space-between;">
            <button class="node-btn" onclick="stepCap(-5)">-</button>
            <input type="number" id="startME" value="50" class="node-input" onchange="save()">
            <button class="node-btn" onclick="stepCap(5)">+</button>
        </div>
    </div>
    <button class="btn-opt" onclick="optimizeTasks()"><i class="fas fa-microchip"></i> OPTIMIZE PATH</button>
    <div id="archive-list" style="overflow-y: auto; flex-grow: 1; border-top: 1px solid var(--border); padding-top: 10px;"></div>
    <button class="btn-sync" onclick="archiveDay()">SYNC CYCLE</button>
</div>

<div class="main-deck">
    <div class="stat-card" style="margin-bottom: 5px;">
        <div style="height: 300px;"><canvas id="energyChart"></canvas></div>
    </div>

    <div class="smart-zone">
        <div style="display:flex; gap:8px; align-items: center;">
            <input type="text" id="newName" placeholder="New SMART Objective..." style="background:none; border:none; border-bottom:1px solid #333; color:white; flex-grow:1; outline:none; font-size: 12px;">
            <div class="node-stepper" title="Energy Cost"><i class="fas fa-battery-quarter" style="font-size:10px; padding-left:5px"></i><input type="number" id="newCost" value="10" class="node-input"></div>
            <div class="node-stepper" title="Energy Gain"><i class="fas fa-battery-full" style="font-size:10px; padding-left:5px; color:var(--gain)"></i><input type="number" id="newGain" value="5" class="node-input"></div>
        </div>
        <div class="smart-grid">
            <input type="text" id="s_in" class="smart-input" placeholder="Specific">
            <input type="text" id="m_in" class="smart-input" placeholder="Measurable">
            <input type="text" id="a_in" class="smart-input" placeholder="Achievable">
            <input type="text" id="r_in" class="smart-input" placeholder="Relevant">
            <input type="text" id="t_in" class="smart-input" placeholder="Time-bound">
        </div>
        <select id="dep_in" class="smart-input" style="text-align-last: center;">
            <option value="">No Prerequisite (Independent)</option>
        </select>
        <button class="btn-sync" onclick="addTask()" style="margin-top:8px; padding:6px; background:var(--accent);">ADD ARCHITECTED TASK</button>
    </div>

    <div id="taskList" style="display: flex; flex-direction: column; gap: 8px;"></div>
</div>

<div class="void-panel">
    <div style="padding:15px; border-bottom:1px solid var(--border); font-size:10px; font-weight:bold;">INTERNAL DIALOGUE</div>
    <div id="chat-log"></div>
    <div style="padding:10px; border-top:1px solid var(--border);">
        <input type="text" id="chatInput" placeholder="Log thought..." style="background:#000; border:1px solid var(--border); color:white; width:100%; padding:6px; border-radius:4px; outline:none; font-size: 11px;" onkeypress="if(event.key==='Enter') sendChat()">
    </div>
</div>

<script>
    let state = JSON.parse(localStorage.getItem('notion_neural_v12')) || {
        tasks: [], startME: 50, history: {}, xp: 0, streak: 0, chat: [], xpClaims: {}
    };
    let chart;

    function init() {
        const ctx = document.getElementById('energyChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'ME', data: [], borderColor: '#00f2ff', tension: 0.4, fill: true, backgroundColor: 'rgba(0,242,255,0.05)', pointRadius: 4 }] },
            options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, grid: { color: '#2f2f2f' } }, x: { ticks: { color: '#888', font: { size: 9 } } } }, plugins: { legend: { display: false } } }
        });
        render();
    }

    function toggleHelp() {
        const modal = document.getElementById('help-modal');
        modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    }

    function stepCap(v) { 
        let current = parseInt(document.getElementById('startME').value);
        document.getElementById('startME').value = Math.min(Math.max(current + v, 0), 100); 
        save(); 
    }

    function addTask() {
        const name = document.getElementById('newName').value;
        if(!name) return;
        state.tasks.push({ 
            id: Date.now().toString(), 
            name, 
            cost: parseInt(document.getElementById('newCost').value) || 0, 
            gain: parseInt(document.getElementById('newGain').value) || 0, 
            done: false, paid: false,
            dep: document.getElementById('dep_in').value,
            s: document.getElementById('s_in').value,
            m: document.getElementById('m_in').value,
            a: document.getElementById('a_in').value,
            r: document.getElementById('r_in').value,
            t: document.getElementById('t_in').value
        });
        document.getElementById('newName').value = '';
        ['s','m','a','r','t'].forEach(k => document.getElementById(k+'_in').value = '');
        save();
    }

    function toggleTask(id) {
        const t = state.tasks.find(t => t.id === id);
        if(t) {
            t.done = !t.done;
            if(t.done && !t.paid) { state.xp += 20; t.paid = true; }
            save();
        }
    }

    function optimizeTasks() {
        if (state.tasks.length === 0) return;

        let uncompleted = state.tasks.filter(t => !t.done);
        let completedIds = new Set(state.tasks.filter(t => t.done).map(t => t.id));
        let optimized = [];
        let currentME = state.startME;
        
        // Recalculate ME based on already completed tasks
        state.tasks.filter(t => t.done).forEach(t => {
            currentME = Math.min(100, currentME + t.gain);
        });

        let iterations = 0;
        let logMsg = "OPTIMIZATION SEQUENCE ACTIVATED: ";

        while (uncompleted.length > 0 && iterations < 100) {
            // Find tasks whose dependencies are met
            let available = uncompleted.filter(t => !t.dep || completedIds.has(t.dep));
            
            if (available.length === 0) {
                logMsg += "Warning: Circular dependency or missing link detected.";
                break;
            }

            // Heuristic: If ME is low (<30), pick the highest GAIN task.
            // If ME is high, pick the highest COST task to get it over with.
            available.sort((a, b) => {
                if (currentME < 30) return b.gain - a.gain;
                return b.cost - a.cost;
            });

            let nextTask = available[0];
            optimized.push(nextTask);
            completedIds.add(nextTask.id);
            uncompleted = uncompleted.filter(t => t.id !== nextTask.id);
            currentME = Math.min(100, Math.max(0, currentME - nextTask.cost + nextTask.gain));
            iterations++;
        }

        // Reorder state.tasks: completed first, then optimized order
        const finalTasks = [...state.tasks.filter(t => t.done), ...optimized];
        state.tasks = finalTasks;
        
        state.chat.push({ 
            msg: `Path Optimized. prioritizing ${optimized[0]?.name || 'current stack'}. Strategy: ${state.startME < 40 ? 'Energy Recovery' : 'Front-loading High Effort'}.`, 
            time: new Date().toLocaleTimeString(),
            isOpt: true
        });
        save();
    }

    function sendChat() {
        const input = document.getElementById('chatInput');
        if(!input.value) return;
        state.chat.push({ msg: input.value, time: new Date().toLocaleTimeString() });
        input.value = '';
        save();
    }

    function save() {
        state.startME = parseInt(document.getElementById('startME').value) || 0;
        localStorage.setItem('notion_neural_v12', JSON.stringify(state));
        render();
    }

    function render() {
        const list = document.getElementById('taskList'); list.innerHTML = '';
        const depSelect = document.getElementById('dep_in');
        depSelect.innerHTML = '<option value="">No Prerequisite (Independent)</option>';

        let cur = state.startME; let chartData = [cur]; let labels = ['Start'];

        state.tasks.forEach((t, i) => {
            // Chart Logic: If done, show gain only. If not done, show impact of cost.
            if(t.done) cur = Math.min(100, cur + t.gain); 
            else cur = Math.min(100, Math.max(0, cur - t.cost + t.gain));

            const div = document.createElement('div');
            div.className = `task-card ${t.done ? 'completed' : ''}`;
            
            const depName = t.dep ? state.tasks.find(x => x.id === t.dep)?.name : null;

            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <div onclick="toggleTask('${t.id}')" style="cursor:pointer; color:${t.done ? 'var(--gain)' : '#333'}"><i class="fas fa-check-circle"></i></div>
                    <div style="flex-grow:1;">
                        <span style="font-weight:bold; font-size:11px; display:block;">${t.name}</span>
                        ${depName ? `<span style="font-size:8px; color:var(--accent)!important;">Requires: ${depName}</span>` : ''}
                    </div>
                    <div class="node-stepper"><input type="number" class="node-input" value="${t.cost}" onchange="updateTaskVal('${t.id}', 'cost', this.value)"></div>
                    <div class="node-stepper" style="color:var(--gain)"><input type="number" class="node-input" value="${t.gain}" onchange="updateTaskVal('${t.id}', 'gain', this.value)"></div>
                    <i class="fas fa-trash trash-btn" style="opacity:0.4; cursor:pointer; font-size:10px;" onclick="deleteTask('${t.id}')"></i>
                </div>
            `;
            list.appendChild(div);
            chartData.push(cur); labels.push(t.name);

            // Populate dependency dropdown for the "Add Task" area
            if(!t.done) {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.innerText = `After: ${t.name}`;
                depSelect.appendChild(opt);
            }
        });

        chart.data.datasets[0].data = chartData; chart.data.labels = labels; chart.update();

        const lvl = Math.floor(state.xp / 100) + 1;
        document.body.className = lvl >= 10 ? 'lvl-10' : lvl >= 5 ? 'lvl-5' : lvl >= 3 ? 'lvl-3' : '';
        document.getElementById('lvl-display').innerText = `LVL ${lvl}`;
        document.getElementById('xp-fill').style.width = `${state.xp % 100}%`;
        document.getElementById('xp-val').innerText = state.xp;
        document.getElementById('streak-val').innerText = state.streak;

        document.getElementById('chat-log').innerHTML = state.chat.slice(-12).map(m => `
            <div class="msg ${m.isOpt ? 'opt' : ''}">
                <b style="font-size:8px; opacity:0.5;">${m.time}</b><br>${m.msg}
            </div>
        `).join('');
        
        const arc = document.getElementById('archive-list');
        arc.innerHTML = Object.keys(state.history).reverse().slice(0,5).map(date => `
            <div style="display:flex; justify-content:space-between; font-size:9px; padding:5px; border-bottom:1px solid #2f2f2f">
                <span>${date}</span>
                <span>${state.history[date].success ? '✓' : '✗'} 
                <button style="background:none; border:none; color:var(--burn); cursor:pointer;" onclick="deleteHistory('${date}')">×</button></span>
            </div>`).join('');
    }

    function updateTaskVal(id, key, val) {
        const t = state.tasks.find(t => t.id === id);
        if(t) t[key] = parseInt(val);
        save();
    }

    function deleteTask(id) {
        state.tasks = state.tasks.filter(t => t.id !== id);
        save();
    }

    function deleteHistory(d) { delete state.history[d]; save(); }

    function archiveDay() {
        const today = new Date().toDateString();
        const success = state.tasks.length > 0 && state.tasks.every(t => t.done);
        if (!state.xpClaims[today] && success) {
            state.xp += 100; state.xpClaims[today] = true; state.streak++;
        } else if (!success) { state.streak = 0; }
        state.history[today] = { success, date: today };
        state.tasks = []; state.chat = []; save();
    }

    init();
</script>
</body>
</html>
